#
# This file has been generated by Puppet
# Don't edit directly
#

server {

	listen <%= @listen_ip %>:<%= @listen_port %>;
	server_name     <%= @server_name.join(" ") %>;
	<% if custom_access_log -%>
	access_log      <%= @log_access %> <%= @custom_access_log %>;
	<% else -%>
	access_log      <%= @log_access %>;
	<% end -%>
	error_log       <%= @log_error %>;
	add_header X-Whom <%= @ipaddress %>;

	<% if root -%>
	root <%= @root %>;
	<% end -%>
	<% if gzip != 'no' -%>
	#
	# gzip
	#
	gzip_static             on;
	gzip_http_version       1.1;
	gzip_proxied            expired no-cache no-store private auth;
	gzip_disable            "MSIE [1-6]\.";
	gzip_vary               on;
	<% end -%>

	<% if ssl != 'no' -%>
	#
	# ssl
	#
	ssl                     on;
	ssl_certificate         <%= @ssl_cert %>;
	ssl_certificate_key     <%= @ssl_key %>;
	<% end -%>

	<% @locations.each do |loc_name,values| -%>
	location <%= loc_name %>  {

		<% if values['disable_log'] -%>
		<% if values['disable_log'].is_a?(Array) -%>
		<% values['disable_log'].each do |value| -%>
		if ($request_filename ~ "<%= value %>") {
			access_log      off;
		}
		<% end -%>
		<% end -%>
		<% end -%>

		<% if values['disable_log_condition'] -%>
		if (<%= values['disable_log_condition'] -%>) {
			access_log      off;
		}
		<% end -%>
		
		root <%= values['root'] -%>;
		<% if values['need_auth'] == 'true' -%>
		auth_basic "<%= values['auth_basic'] -%>";
		auth_basic_user_file <%= values['auth_basic_user_file'] -%>;
		<% end -%>
		<% if values['include'] -%>
		include <%= values['include'] -%>;

		<% end -%>
		<% if values['index'] -%>
		index <%= values['index'] -%>;

		<% end -%>
		<% if values['custom_params'] -%>
		<% values['custom_params'].each do |key,value| -%>
		<%= key -%> <%= value -%>;
		<% end -%>
		<% end -%>
		<% if values['bigint_svn_prefix'] -%>
      		   if ($request_filename ~ "/static[0-9a-f]+") {
      	 	      rewrite /[^\/]+/(.*) /static/$1;
		  }
		<% end -%>
	}

	<% end -%>

	location ~ /\.ht {
            deny  all;
	}

	location ~ /\.svn {
	    deny  all;
	}

	#
	# Error pages
	#
	error_page  404  /404.html;
	#   error_page   500 502 503 504  /50x.html;
	#   location = /50x.html {
	#      root   <%= @location_on_50x %>;
	#   }

	<% if nginx_status != 'no' -%>
	#
	# Status for collectd
	#
	location /nginx_status {
		stub_status on;
		access_log off;
		allow <%= @nginx_status_allow.join(" ") %>;
		deny all;
	}
	<% end -%>
}

<% if @rewrite_http_to_https -%>
server {
	listen <%= listen_ip %>:80;
	server_name <%= @server_name.join(" ") %>;
	rewrite ^ https://<%= name %>$request_uri permanent;
}
<% end -%>
